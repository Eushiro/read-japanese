#!/bin/sh

echo "Running pre-commit checks..."

# Get list of staged files (repo-root-relative paths)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# 1. Check for secrets in staged files
echo "Checking for secrets..."
echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|json|env)$' | xargs bunx secretlint --secretlintrcFilePath web/.secretlintrc.json 2>/dev/null || true

# 2. Auto-format staged files with Prettier (non-blocking, just fixes)
echo "Auto-formatting with Prettier..."
echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json|css|md)$' | xargs bunx prettier --write 2>/dev/null
# Re-add formatted files to staging
echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json|css|md)$' | xargs git add 2>/dev/null || true

cd web || exit 1

# 3. TypeScript type checking
echo "Type checking..."
bun run typecheck || exit 1

# 4. ESLint on staged files (fails on warnings)
echo "Linting..."
bunx lint-staged || exit 1

# 5. Check translation key parity
echo "Checking i18n keys..."
bun run check-i18n || exit 1

# 6. Convex type checking (blocks on errors)
echo "Checking Convex types..."
bunx convex typecheck || exit 1

# 7. Check for pattern violations (hardcoded languages, etc.)
echo "Checking code patterns..."
bun run check-patterns || exit 1

# 7b. Check credit charging guardrails
echo "Checking credit charging..."
bun run check-credits || exit 1

# 8. Run smoke tests
echo "Running tests..."
bun test || exit 1

cd ..

# 9. Python linting with Ruff (if backend files changed)
if echo "$STAGED_FILES" | grep -q "^backend/"; then
    echo "Linting Python with Ruff..."
    cd backend
    source venv/bin/activate
    ruff check . || exit 1
    ruff format --check . || exit 1

    echo "Checking backend patterns..."
    python scripts/lint_patterns.py || exit 1
    deactivate
    cd ..
fi

# 10. Claude Code review (blocking)
echo "Running Claude Code review..."

# Get staged diff
diff=$(git diff --cached)

if [ -n "$diff" ]; then
    if command -v claude &> /dev/null; then
        # Include key guideline files in context
        claude_md=$(cat CLAUDE.md 2>/dev/null || echo "")
        dev_md=$(cat docs/DEVELOPMENT.md 2>/dev/null || echo "")

        review_prompt="You are reviewing staged changes before commit. You are a senior engineer — only flag issues you are highly confident about.

## Review Categories
1. **Bugs or logic errors** in the changed code
2. **Security issues** (hardcoded secrets, injection vulnerabilities)
3. **CLAUDE.md violations** — Must cite the specific guideline being violated
4. **docs/ violations** — Must cite the specific pattern being violated
5. **Documentation updates needed** — New patterns, features, or architecture changes that need docs

## Confidence Scoring
For each potential issue, assign a confidence score 0-100:
- 0-25: Likely false positive or pre-existing issue
- 50: Might be real but unverified or minor
- 75: Verified real, important, impacts functionality
- 100: Absolutely certain, strong evidence

**Only report issues with confidence ≥80.**

## Ignore (other tools already check these)
- TypeScript type errors (tsc already ran)
- ESLint violations (ESLint already ran)
- Formatting issues (Prettier already ran)
- Import ordering or unused imports
- Pre-existing issues in unchanged code
- Pedantic nitpicks a senior engineer wouldn't flag
- General code quality suggestions unless explicitly in CLAUDE.md

## Output Format
If issues found with confidence ≥80:
- Use \"BLOCKER:\" prefix for bugs/security/guideline violations. Include the confidence score and cite evidence.
- Use \"UPDATE_DOCS:\" prefix if documentation needs updating. Specify which doc file and what to add.

If no issues meet the ≥80 threshold, respond with only: \"LGTM\"

=== CLAUDE.md Guidelines ===
$claude_md

=== Development Guidelines (docs/DEVELOPMENT.md) ===
$dev_md

=== Staged Diff ===
$diff"

        result=$(echo "$review_prompt" | claude -p --output-format text 2>&1)
        echo ""
        echo "=== Claude Code Review ==="
        echo "$result"
        echo "=========================="

        # Block only on explicit BLOCKER: or UPDATE_DOCS: prefixes from review
        if echo "$result" | grep -qE "(BLOCKER:|UPDATE_DOCS:)"; then
            echo ""
            echo "Review found issues that need attention. Commit blocked."
            echo "Fix the issues above and try committing again."
            exit 1
        fi
    else
        echo "Note: 'claude' command not found. Skipping AI review."
    fi
fi

echo "All checks passed!"
