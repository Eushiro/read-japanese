#!/bin/sh

echo "Running pre-commit checks..."

# Get list of staged files (repo-root-relative paths)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# 1. Check for secrets in staged files
echo "Checking for secrets..."
echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|json|env)$' | xargs bunx secretlint --secretlintrcFilePath web/.secretlintrc.json 2>/dev/null || true

# 2. Auto-format staged files with Prettier (non-blocking, just fixes)
echo "Auto-formatting with Prettier..."
echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json|css|md)$' | xargs bunx prettier --write 2>/dev/null
# Re-add formatted files to staging
echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json|css|md)$' | xargs git add 2>/dev/null || true

cd web || exit 1

# 3. TypeScript type checking
echo "Type checking..."
bun run typecheck || exit 1

# 4. ESLint on staged files (fails on warnings)
echo "Linting..."
bunx lint-staged || exit 1

# 5. Check translation key parity
echo "Checking i18n keys..."
bun run check-i18n || exit 1

# 6. Convex type checking (blocks on errors)
echo "Checking Convex types..."
bunx convex typecheck || exit 1

echo "All checks passed!"
