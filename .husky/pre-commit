#!/bin/sh

echo "Running pre-commit checks..."

# Get list of staged files (repo-root-relative paths)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# 1. Check for secrets in staged files
echo "Checking for secrets..."
echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|json|env)$' | xargs bunx secretlint --secretlintrcFilePath web/.secretlintrc.json 2>/dev/null || true

# 2. Auto-format staged files with Prettier (non-blocking, just fixes)
echo "Auto-formatting with Prettier..."
echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json|css|md)$' | xargs bunx prettier --write 2>/dev/null
# Re-add formatted files to staging
echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json|css|md)$' | xargs git add 2>/dev/null || true

cd web || exit 1

# 3. TypeScript type checking
echo "Type checking..."
bun run typecheck || exit 1

# 4. ESLint on staged files (fails on warnings)
echo "Linting..."
bunx lint-staged || exit 1

# 5. Check translation key parity
echo "Checking i18n keys..."
bun run check-i18n || exit 1

# 6. Convex type checking (blocks on errors)
echo "Checking Convex types..."
bunx convex typecheck || exit 1

# 7. Check for pattern violations (hardcoded languages, etc.)
echo "Checking code patterns..."
bun run check-patterns || exit 1

# 7b. Check credit charging guardrails
echo "Checking credit charging..."
bun run check-credits || exit 1

# 8. Run smoke tests
echo "Running tests..."
bun test || exit 1

cd ..

# 9. Python linting with Ruff (if backend files changed)
if echo "$STAGED_FILES" | grep -q "^backend/"; then
    echo "Linting Python with Ruff..."
    cd backend
    source venv/bin/activate
    ruff check . || exit 1
    ruff format --check . || exit 1

    echo "Checking backend patterns..."
    python scripts/lint_patterns.py || exit 1
    deactivate
    cd ..
fi

echo "All checks passed!"
