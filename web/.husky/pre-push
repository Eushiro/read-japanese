#!/bin/sh

# Pre-push hook: Claude Code review of commits about to be pushed
# Runs Claude to review the diff between local and remote

echo "Running Claude Code review before push..."

# Get the remote and branch being pushed to
remote="$1"
url="$2"

# Read the stdin to get refs being pushed
while read local_ref local_sha remote_ref remote_sha; do
    # Skip delete pushes
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        continue
    fi

    # Determine the range of commits to review
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch - compare against main/master
        base=$(git rev-parse --verify origin/main 2>/dev/null || git rev-parse --verify origin/master 2>/dev/null || echo "")
        if [ -z "$base" ]; then
            echo "Warning: No remote main/master found, skipping review"
            continue
        fi
        range="$base..$local_sha"
    else
        # Existing branch - compare against remote
        range="$remote_sha..$local_sha"
    fi

    # Get the diff
    diff=$(git diff "$range" 2>/dev/null)

    if [ -z "$diff" ]; then
        echo "No changes to review"
        continue
    fi

    # Count lines in diff to avoid reviewing huge changes
    diff_lines=$(echo "$diff" | wc -l)
    if [ "$diff_lines" -gt 2000 ]; then
        echo "Warning: Large diff ($diff_lines lines). Review may be slow or truncated."
    fi

    # Get commit messages for context
    commits=$(git log --oneline "$range" 2>/dev/null)

    echo "Reviewing $range..."
    echo "Commits:"
    echo "$commits"
    echo ""

    # Run Claude Code for review (non-blocking by default, set CLAUDE_REVIEW_BLOCK=1 to block)
    review_prompt="Review this git diff for issues before it's pushed. Focus on:
1. Bugs or logic errors
2. Security issues (hardcoded secrets, injection vulnerabilities)
3. CLAUDE.md violations (check the project's CLAUDE.md for coding standards)

Be concise. Only flag real issues, not style nitpicks. If everything looks good, say so briefly.

Commits being pushed:
$commits

Diff:
$diff"

    # Check if claude command exists
    if ! command -v claude &> /dev/null; then
        echo "Warning: 'claude' command not found. Skipping AI review."
        echo "Install Claude Code to enable pre-push reviews."
        exit 0
    fi

    # Run review
    if [ "${CLAUDE_REVIEW_BLOCK:-0}" = "1" ]; then
        # Blocking mode - must pass review to push
        echo "Running blocking review (CLAUDE_REVIEW_BLOCK=1)..."
        result=$(echo "$review_prompt" | claude -p --output-format text 2>&1)
        echo ""
        echo "=== Claude Code Review ==="
        echo "$result"
        echo "=========================="
        echo ""

        # Check if review found critical issues (look for keywords)
        if echo "$result" | grep -qiE "(critical|blocker|must fix|security vulnerability|hardcoded secret)"; then
            echo "Review found critical issues. Push blocked."
            echo "Fix the issues and try again, or push with --no-verify to skip."
            exit 1
        fi
    else
        # Non-blocking mode - show review but don't block
        echo "Running review (non-blocking)..."
        echo "$review_prompt" | claude -p --output-format text 2>&1 &
        review_pid=$!

        # Wait briefly for fast responses, then continue
        sleep 2
        if kill -0 $review_pid 2>/dev/null; then
            echo "Review still running in background (pid: $review_pid)"
            echo "Push will continue. Check terminal for review results."
        else
            wait $review_pid
        fi
    fi
done

echo "Pre-push check complete."
exit 0
